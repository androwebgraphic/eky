{"ast":null,"code":"import _objectSpread from\"/Applications/MAMP/htdocs/eky/client/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect,useRef,useCallback}from'react';import{useTranslation}from'react-i18next';import'../css/chat-app.css';import'../styles/chatAppNotification.css';import io from'socket.io-client';import{useAuth}from'../contexts/AuthContext';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const getApiUrl=()=>{if(process.env.REACT_APP_API_URL)return process.env.REACT_APP_API_URL;if(window.location.protocol==='https:'){// Use same host, but https\nreturn\"https://\".concat(window.location.hostname);}if(window.location.hostname==='localhost'||window.location.hostname==='127.0.0.1'){return\"http://\".concat(window.location.hostname,\":3001\");}// For mobile/network access, use the network IP (dev only)\nreturn\"http://172.20.10.2:3001\";};const ChatApp=()=>{const{t}=useTranslation();// Helper to refresh online users from server\nconst refreshOnlineUsers=useCallback(()=>{if(socketRef.current){socketRef.current.emit('getOnlineUsers');}},[]);const{user,token,updateUser}=useAuth();const selectedConvoRef=useRef(null);const[onlineUsers,setOnlineUsers]=useState([]);const userWithBlocks=user;// Profile picture logic\nconst getProfilePictureUrl=()=>{if(user&&user.profilePicture){return\"\".concat(getApiUrl()).concat(user.profilePicture);}return'../img/androcolored-80x80.jpg';// Default profile picture\n};const[conversations,setConversations]=useState([]);const[convoUsernames,setConvoUsernames]=useState({});const[selectedConvo,setSelectedConvo]=useState(null);useEffect(()=>{selectedConvoRef.current=selectedConvo;},[selectedConvo]);const[messages,setMessages]=useState([]);const[input,setInput]=useState('');// Remove otherUserId, use only user search and searchResults\nconst[typing,setTyping]=useState(false);const[notification,setNotification]=useState(null);const[userSearch,setUserSearch]=useState('');const[searchResults,setSearchResults]=useState([]);const[pendingAdoptions,setPendingAdoptions]=useState([]);useEffect(()=>{console.log('[ChatApp] onlineUsers state updated:',onlineUsers);},[onlineUsers]);const socketRef=useRef(null);const fetchPendingAdoptions=useCallback(async()=>{if(!token)return;console.log('[ChatApp] Fetching pending adoptions...');try{const res=await fetch(\"\".concat(getApiUrl(),\"/api/dogs/pending-adoptions\"),{headers:{'Authorization':\"Bearer \".concat(token)}});if(res.ok){const data=await res.json();console.log('[ChatApp] Current user:',user===null||user===void 0?void 0:user._id);console.log('[ChatApp] Pending adoptions:',data);setPendingAdoptions(data);}else{console.error('[ChatApp] Failed to fetch pending adoptions:',res.status);}}catch(err){console.error('[ChatApp] Error fetching pending adoptions:',err);}},[token]);// Setup socket connection and listeners only once per user/token\nuseEffect(()=>{if(user!==null&&user!==void 0&&user._id&&token){console.log('[ChatApp] useEffect: user._id and token present.');console.log('[ChatApp] Connecting socket for user:',user._id);fetch(\"\".concat(getApiUrl(),\"/api/chat/conversations/\").concat(user._id),{headers:{'Authorization':\"Bearer \".concat(token)}}).then(res=>{if(!res.ok){throw new Error(\"HTTP \".concat(res.status,\": \").concat(res.statusText));}return res.json();}).then(async data=>{console.log('[ChatApp] Conversations fetched:',data);setConversations(Array.isArray(data)?data:[]);// Fetch usernames for each conversation's other participant\nconst usernames={};for(const convo of Array.isArray(data)?data:[]){const otherId=convo.participants.find(id=>id!==user._id);if(otherId){try{const res=await fetch(\"\".concat(getApiUrl(),\"/api/users/\").concat(otherId),{headers:{'Authorization':\"Bearer \".concat(token)}});if(res.status===404){usernames[convo._id]='[Deleted User]';}else if(res.ok){const u=await res.json();usernames[convo._id]=u.username||u.name||otherId;}else{usernames[convo._id]=otherId;}}catch(err){usernames[convo._id]='[Error]';}}}setConvoUsernames(usernames);await fetchPendingAdoptions();});if(!socketRef.current){socketRef.current=io(getApiUrl());console.log('[ChatApp] Socket.IO connecting to',getApiUrl());socketRef.current.on('connect',()=>{console.log('[ChatApp] Socket connected');});socketRef.current.on('connect_error',error=>{console.error('[ChatApp] Socket connection error:',error);});socketRef.current.on('receiveMessage',msg=>{console.log('[ChatApp] receiveMessage event:',msg);});socketRef.current.on('refreshConversations',()=>{console.log('[ChatApp] refreshConversations event received');});socketRef.current.on('connect',()=>{console.log('[ChatApp] Socket connected successfully');});socketRef.current.on('connect_error',error=>{console.error('[ChatApp] Socket connection error:',error);});socketRef.current.emit('join',user._id);console.log('[ChatApp] Emitted join for user:',user._id);socketRef.current.emit('getOnlineUsers');socketRef.current.on('onlineUsers',users=>{console.log('[ChatApp] Received onlineUsers:',users);setOnlineUsers(users.filter(u=>u._id!==user._id));});socketRef.current.on('userOnline',userOnline=>{console.log('[ChatApp] userOnline event:',userOnline);setOnlineUsers(prev=>{if(prev.some(u=>u._id===userOnline._id))return prev;return[...prev,userOnline].filter(u=>u._id!==user._id);});});socketRef.current.on('userOffline',userOffline=>{console.log('[ChatApp] userOffline event:',userOffline);setOnlineUsers(prev=>prev.filter(u=>u._id!==userOffline._id));});socketRef.current.on('receiveMessage',msg=>{console.log('[ChatApp] receiveMessage event:',msg);// Always refresh conversations list\nfetch(\"\".concat(getApiUrl(),\"/api/chat/conversations/\").concat(user._id),{headers:{'Authorization':\"Bearer \".concat(token)}}).then(res=>res.json()).then(async data=>{setConversations(Array.isArray(data)?data:[]);// Fetch usernames for each conversation's other participant\nconst usernames={};for(const convo of Array.isArray(data)?data:[]){const otherId=convo.participants.find(id=>id!==user._id);if(otherId){const res=await fetch(\"\".concat(getApiUrl(),\"/api/users/\").concat(otherId));if(res.ok){const u=await res.json();usernames[convo._id]=u.username||u.name||otherId;}else{usernames[convo._id]=otherId;}}}setConvoUsernames(usernames);// Always refresh messages for the relevant conversation\nif(msg.conversationId){fetch(\"\".concat(getApiUrl(),\"/api/chat/messages/\").concat(msg.conversationId),{headers:{'Authorization':\"Bearer \".concat(token)}}).then(res=>res.json()).then(messages=>{setMessages(messages);// Show notification for system messages\nif(msg.sender===null&&msg.message){setNotification(msg.message);setTimeout(()=>setNotification(null),4000);// Auto-select the conversation if not already selected\nif(!selectedConvo||selectedConvo._id!==msg.conversationId){const foundConvo=(Array.isArray(data)?data:[]).find(c=>c._id===msg.conversationId);if(foundConvo)setSelectedConvo(foundConvo);}// Mark conversation as having a new system message (badge)\nsetConvoUsernames(prev=>_objectSpread(_objectSpread({},prev),{},{[msg.conversationId]:(prev[msg.conversationId]||'')+' •'}));}});}// Always refresh pending adoptions on receiveMessage (for adoption events)\nfetchPendingAdoptions();});});socketRef.current.on('typing',_ref=>{let{from}=_ref;setTyping(true);setTimeout(()=>setTyping(false),1500);});socketRef.current.on('notification',_ref2=>{let{from,message}=_ref2;setNotification(\"New message from \".concat(from,\": \").concat(message));setTimeout(()=>setNotification(null),3000);});socketRef.current.on('refreshConversations',()=>{console.log('[ChatApp] refreshConversations event received');fetch(\"\".concat(getApiUrl(),\"/api/chat/conversations/\").concat(user._id),{headers:{'Authorization':\"Bearer \".concat(token)}}).then(res=>{if(!res.ok){throw new Error(\"HTTP \".concat(res.status,\": \").concat(res.statusText));}return res.json();}).then(data=>{console.log('[ChatApp] Conversations refreshed:',data);setConversations(Array.isArray(data)?data:[]);}).catch(err=>{console.error('[ChatApp] Error refreshing conversations:',err);});fetchPendingAdoptions();});}}return()=>{var _socketRef$current;(_socketRef$current=socketRef.current)===null||_socketRef$current===void 0?void 0:_socketRef$current.disconnect();socketRef.current=null;};},[user,token,selectedConvo,fetchPendingAdoptions]);useEffect(()=>{if(selectedConvo&&token){console.log('[ChatApp] Fetching messages for selectedConvo:',selectedConvo._id);fetch(\"\".concat(getApiUrl(),\"/api/chat/messages/\").concat(selectedConvo._id),{headers:{'Authorization':\"Bearer \".concat(token)}}).then(res=>res.json()).then(setMessages);}},[selectedConvo,token]);useEffect(()=>{if(selectedConvo&&token){console.log('[ChatApp] Fetching messages for selectedConvo (user/token change):',selectedConvo._id);fetch(\"\".concat(getApiUrl(),\"/api/chat/messages/\").concat(selectedConvo._id),{headers:{'Authorization':\"Bearer \".concat(token)}}).then(res=>res.json()).then(setMessages);}},[user,token,selectedConvo]);const startConversation=async otherUserId=>{if(!otherUserId||!token)return;const res=await fetch(\"\".concat(getApiUrl(),\"/api/chat/conversation\"),{method:'POST',headers:{'Content-Type':'application/json','Authorization':\"Bearer \".concat(token)},body:JSON.stringify({userId:user._id,otherUserId})});const convo=await res.json();setSelectedConvo(convo);setConversations(prev=>[...prev,convo]);setUserSearch('');setSearchResults([]);};const sendMessage=async()=>{var _socketRef$current2;if(!input||!selectedConvo||!token)return;const recipient=selectedConvo.participants.find(id=>id!==user._id);(_socketRef$current2=socketRef.current)===null||_socketRef$current2===void 0?void 0:_socketRef$current2.emit('sendMessage',{conversationId:selectedConvo._id,sender:user._id,recipient,message:input});await fetch(\"\".concat(getApiUrl(),\"/api/chat/message\"),{method:'POST',headers:{'Content-Type':'application/json','Authorization':\"Bearer \".concat(token)},body:JSON.stringify({conversationId:selectedConvo._id,sender:user._id,recipient,message:input})});// Do not update messages here; wait for real-time event\nsetInput('');};// Typing indicator\nconst handleInputChange=e=>{setInput(e.target.value);if(selectedConvo){var _socketRef$current3;const recipient=selectedConvo.participants.find(id=>id!==user._id);(_socketRef$current3=socketRef.current)===null||_socketRef$current3===void 0?void 0:_socketRef$current3.emit('typing',{recipient,sender:user._id});}};// User search\nconst handleUserSearch=async e=>{setUserSearch(e.target.value);if(e.target.value.length>1){try{const res=await fetch(\"\".concat(getApiUrl(),\"/api/users/search?query=\").concat(encodeURIComponent(e.target.value)),{headers:{'Authorization':\"Bearer \".concat(token)}});if(!res.ok){console.error('User search failed:',res.status,await res.text());setSearchResults([]);return;}const results=await res.json();setSearchResults(results);}catch(err){console.error('User search error:',err);setSearchResults([]);}}else{setSearchResults([]);}};// Handler for deleting conversation\nconst handleDeleteConversation=async()=>{if(!selectedConvo||!token)return;if(!window.confirm('Delete this conversation? This cannot be undone.'))return;await fetch(\"\".concat(getApiUrl(),\"/api/chat/messages/\").concat(selectedConvo._id),{method:'DELETE',headers:{'Authorization':\"Bearer \".concat(token)}});setConversations(conversations.filter(c=>c._id!==selectedConvo._id));setSelectedConvo(null);setMessages([]);};// Handler for block/unblock user\nconst isBlocked=selectedConvo&&userWithBlocks&&userWithBlocks.blockedUsers&&selectedConvo.participants.some(id=>id!==userWithBlocks._id&&userWithBlocks.blockedUsers.includes(id));const otherUserId=selectedConvo&&userWithBlocks?selectedConvo.participants.find(id=>id!==userWithBlocks._id):null;const handleBlockUnblock=async()=>{if(!otherUserId||!token)return;const url=isBlocked?'/api/chat/unblock':'/api/chat/block';await fetch(\"\".concat(getApiUrl()).concat(url),{method:'POST',headers:{'Content-Type':'application/json','Authorization':\"Bearer \".concat(token)},body:JSON.stringify({userId:user._id,blockId:otherUserId})});// Fetch updated user and update AuthContext state\nconst userRes=await fetch(\"\".concat(getApiUrl(),\"/api/users/\").concat(user._id),{headers:{'Authorization':\"Bearer \".concat(token)}});if(userRes.ok){const updatedUser=await userRes.json();updateUser(updatedUser);}// Emit a socket event to update both users' conversations in real time\nif(socketRef.current){socketRef.current.emit('refreshConversations',{userId:user._id,otherUserId});}// Refetch conversations for this user\nfetch(\"\".concat(getApiUrl(),\"/api/chat/conversations/\").concat(user._id),{headers:{'Authorization':\"Bearer \".concat(token)}}).then(res=>res.json()).then(data=>setConversations(Array.isArray(data)?data:[]));// Optionally, refetch selected conversation if still valid\nif(selectedConvo){fetch(\"\".concat(getApiUrl(),\"/api/chat/messages/\").concat(selectedConvo._id),{headers:{'Authorization':\"Bearer \".concat(token)}}).then(res=>res.json()).then(setMessages);}};// Handler for confirming adoption\nconst handleConfirmAdoption=async(dogId,isOwner)=>{if(!token)return;try{const res=await fetch(\"\".concat(getApiUrl(),\"/api/dogs/confirm-adoption\"),{method:'POST',headers:{'Content-Type':'application/json','Authorization':\"Bearer \".concat(token)},body:JSON.stringify({dogId,isOwner})});if(res.ok){await fetchPendingAdoptions();setNotification(t('chat.adoptionConfirmed'));// Always refresh conversations\nfetch(\"\".concat(getApiUrl(),\"/api/chat/conversations/\").concat(user._id),{headers:{'Authorization':\"Bearer \".concat(token)}}).then(res=>res.json()).then(data=>{setConversations(Array.isArray(data)?data:[]);// If selected convo is gone, clear selection and messages\nif(selectedConvo&&!data.find(c=>c._id===selectedConvo._id)){setSelectedConvo(null);setMessages([]);setNotification(t('chat.adoptionCompletedClosed'));}else if(selectedConvo){// Refresh messages if convo still exists\nfetch(\"\".concat(getApiUrl(),\"/api/chat/messages/\").concat(selectedConvo._id),{headers:{'Authorization':\"Bearer \".concat(token)}}).then(res=>res.json()).then(setMessages);}});}}catch(err){console.error('Confirm adoption error:',err);}};// Handler for canceling adoption\nconst handleCancelAdoption=async dogId=>{if(!token)return;try{const res=await fetch(\"\".concat(getApiUrl(),\"/api/dogs/\").concat(dogId,\"/adopt-cancel\"),{method:'POST',headers:{'Content-Type':'application/json','Authorization':\"Bearer \".concat(token)},body:JSON.stringify({reason:''})});if(res.ok){await fetchPendingAdoptions();setNotification(t('chat.adoptionCanceled'));fetch(\"\".concat(getApiUrl(),\"/api/chat/conversations/\").concat(user._id),{headers:{'Authorization':\"Bearer \".concat(token)}}).then(res=>res.json()).then(data=>{setConversations(Array.isArray(data)?data:[]);if(selectedConvo&&!data.find(c=>c._id===selectedConvo._id)){setSelectedConvo(null);setMessages([]);setNotification(t('chat.adoptionCanceledClosed'));}else if(selectedConvo){fetch(\"\".concat(getApiUrl(),\"/api/chat/messages/\").concat(selectedConvo._id),{headers:{'Authorization':\"Bearer \".concat(token)}}).then(res=>res.json()).then(setMessages);}});}}catch(err){console.error('Cancel adoption error:',err);}};return/*#__PURE__*/_jsxs(\"div\",{className:\"chat-app-container\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"chat-app-sidebar\",children:[/*#__PURE__*/_jsx(\"input\",{className:\"chat-app-search\",type:\"text\",value:userSearch,onChange:handleUserSearch,placeholder:t('chat.searchUsersPlaceholder')}),searchResults.length>0&&/*#__PURE__*/_jsx(\"ul\",{style:{listStyle:'none',padding:0,marginBottom:4},children:searchResults.map(u=>/*#__PURE__*/_jsx(\"li\",{children:/*#__PURE__*/_jsx(\"button\",{className:\"chat-app-convo-btn\",onClick:()=>startConversation(u._id),children:u.userName})},u._id))}),/*#__PURE__*/_jsxs(\"div\",{className:\"chat-app-online-users\",children:[/*#__PURE__*/_jsx(\"b\",{style:{fontSize:13,color:'#43b581'},children:\"Online Users\"}),/*#__PURE__*/_jsxs(\"ul\",{style:{listStyle:'none',padding:0,minHeight:40},children:[onlineUsers.filter(u=>{const id=typeof u==='string'?u:u._id;return String(id)!==String(user._id);}).length===0&&/*#__PURE__*/_jsx(\"li\",{style:{color:'#aaa',fontSize:12},children:t('chat.noUsersOnline')}),onlineUsers.filter(u=>{const id=typeof u==='string'?u:u._id;return String(id)!==String(user._id);}).map(u=>{let displayName='';let profileImg='../img/androcolored-80x80.jpg';if(typeof u==='string'){displayName=u;}else if(u&&typeof u==='object'){displayName=u.userName||u._id||'Unknown';if(u.profilePicture){profileImg=\"\".concat(getApiUrl()).concat(u.profilePicture);}}return/*#__PURE__*/_jsxs(\"li\",{style:{display:'flex',flexDirection:'column',alignItems:'center',gap:4,marginBottom:8},children:[/*#__PURE__*/_jsx(\"span\",{className:\"chat-app-online-dot\",style:{position:'absolute',left:8,top:8}}),/*#__PURE__*/_jsx(\"img\",{src:profileImg,alt:displayName,style:{width:40,height:40,borderRadius:'50%',objectFit:'cover',border:'2px solid #ddd',minWidth:'40px',minHeight:'40px',maxWidth:'60px',maxHeight:'60px',marginBottom:4},onError:e=>{e.target.src='../img/androcolored-80x80.jpg';}}),/*#__PURE__*/_jsx(\"button\",{className:\"chat-app-convo-btn\",style:{fontSize:13,fontWeight:500,marginTop:2},onClick:()=>startConversation(typeof u==='string'?u:u._id),children:displayName})]},typeof u==='string'?u:u._id);})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"chat-app-convos\",children:[/*#__PURE__*/_jsx(\"b\",{style:{fontSize:13,color:'#2196f3'},children:\"Conversations\"}),/*#__PURE__*/_jsx(\"ul\",{style:{listStyle:'none',padding:0},children:conversations.map(convo=>/*#__PURE__*/_jsx(\"li\",{children:/*#__PURE__*/_jsx(\"button\",{className:\"chat-app-convo-btn\".concat((selectedConvo===null||selectedConvo===void 0?void 0:selectedConvo._id)===convo._id?' selected':''),onClick:()=>setSelectedConvo(convo),children:convoUsernames[convo._id]||convo.participants.filter(id=>id!==user._id).join(', ')})},convo._id))})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"chat-app-main\",children:[/*#__PURE__*/_jsxs(\"div\",{style:{background:'#fff3cd',padding:'8px',marginBottom:'8px',border:'1px solid #ffeaa7',borderRadius:'4px'},children:[/*#__PURE__*/_jsx(\"strong\",{children:t('chat.pendingAdoptions')}),pendingAdoptions.length>0?/*#__PURE__*/_jsx(\"ul\",{style:{margin:0,paddingLeft:'20px'},children:pendingAdoptions.map(dog=>{var _dog$adoptionQueue;let adopter='None';const a=(_dog$adoptionQueue=dog.adoptionQueue)===null||_dog$adoptionQueue===void 0?void 0:_dog$adoptionQueue.adopter;if(a){if(typeof a==='string'){adopter=a;}else if(typeof a==='object'){adopter=a.name||a.username||a._id||'Unknown';}}return/*#__PURE__*/_jsxs(\"li\",{children:[dog.name,\" - Owner: \",dog.user.name,\" (\",dog.user._id===user._id?'You':'Other',\") - Adopter: \",adopter]},dog._id);})}):/*#__PURE__*/_jsx(\"div\",{style:{color:'#c00',fontSize:'13px',marginTop:6},children:t('chat.noPendingAdoptions')})]}),selectedConvo&&/*#__PURE__*/_jsxs(\"div\",{className:\"chat-app-actions-row\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"chat-app-action-btn delete\",onClick:handleDeleteConversation,children:\"Delete\"}),/*#__PURE__*/_jsx(\"button\",{className:\"chat-app-action-btn \".concat(isBlocked?'unblock':'block'),onClick:handleBlockUnblock,children:isBlocked?'Unblock':'Block'}),pendingAdoptions.filter(dog=>dog.adoptionStatus!=='adopted').length>0?pendingAdoptions.filter(dog=>dog.adoptionStatus!=='adopted').map(dog=>/*#__PURE__*/_jsxs(\"span\",{style:{display:'inline-flex',gap:8},children:[/*#__PURE__*/_jsx(\"button\",{className:\"chat-app-action-btn confirm\",onClick:()=>handleConfirmAdoption(dog._id,String(dog.user._id||dog.user)===String(user._id)),children:\"Confirm\"}),/*#__PURE__*/_jsx(\"button\",{className:\"chat-app-action-btn cancel\",onClick:()=>handleCancelAdoption(dog._id),style:{background:'#e74c3c',color:'white'},children:\"Cancel\"})]},dog._id)):/*#__PURE__*/_jsx(\"span\",{style:{color:'#c00',fontSize:'12px'},children:\"No pending adoptions found.\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"chat-app-messages\",children:[messages.map(msg=>/*#__PURE__*/_jsx(\"div\",{className:\"chat-app-message\".concat(user&&msg.sender===user._id?' self':'').concat(msg.sender===null?' system':''),style:msg.sender===null?{textAlign:'center',color:'#888',fontStyle:'italic',background:'#f9f9f9',border:'none',margin:'8px 0'}:{},children:/*#__PURE__*/_jsx(\"span\",{className:\"chat-app-bubble\".concat(user&&msg.sender===user._id?' self':''),children:msg.message})},msg._id)),typing&&/*#__PURE__*/_jsx(\"div\",{className:\"chat-app-typing\",children:t('chat.typing')})]}),selectedConvo&&/*#__PURE__*/_jsxs(\"div\",{className:\"chat-app-input-row\",children:[/*#__PURE__*/_jsx(\"input\",{className:\"chat-app-input\",type:\"text\",value:input,onChange:handleInputChange,onKeyDown:e=>{if(e.key==='Enter')sendMessage();},placeholder:'Type a message...'}),/*#__PURE__*/_jsx(\"button\",{className:\"chat-app-send-btn\",onClick:sendMessage,disabled:!input.trim(),children:\"Send\"})]}),notification&&/*#__PURE__*/_jsx(\"div\",{className:\"chat-app-notification\",children:notification})]}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>window.dispatchEvent(new CustomEvent('closeChatModal')),style:{position:'absolute',top:10,right:10,width:56,height:56,backgroundColor:'#e74c3c',color:'#fff',border:'none',borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',boxShadow:'0 4px 12px rgba(0,0,0,0.3)',cursor:'pointer',zIndex:2147483647,padding:0},title:\"Close\",\"aria-label\":\"Close\",children:/*#__PURE__*/_jsx(\"span\",{style:{fontSize:40,fontWeight:900,lineHeight:'56px',width:'100%',textAlign:'center',display:'block',userSelect:'none',letterSpacing:2},children:\"\\xD7\"})})]});};export default ChatApp;","map":{"version":3,"names":["React","useState","useEffect","useRef","useCallback","useTranslation","io","useAuth","jsx","_jsx","jsxs","_jsxs","getApiUrl","process","env","REACT_APP_API_URL","window","location","protocol","concat","hostname","ChatApp","t","refreshOnlineUsers","socketRef","current","emit","user","token","updateUser","selectedConvoRef","onlineUsers","setOnlineUsers","userWithBlocks","getProfilePictureUrl","profilePicture","conversations","setConversations","convoUsernames","setConvoUsernames","selectedConvo","setSelectedConvo","messages","setMessages","input","setInput","typing","setTyping","notification","setNotification","userSearch","setUserSearch","searchResults","setSearchResults","pendingAdoptions","setPendingAdoptions","console","log","fetchPendingAdoptions","res","fetch","headers","ok","data","json","_id","error","status","err","then","Error","statusText","Array","isArray","usernames","convo","otherId","participants","find","id","u","username","name","on","msg","users","filter","userOnline","prev","some","userOffline","conversationId","sender","message","setTimeout","foundConvo","c","_objectSpread","_ref","from","_ref2","catch","_socketRef$current","disconnect","startConversation","otherUserId","method","body","JSON","stringify","userId","sendMessage","_socketRef$current2","recipient","handleInputChange","e","target","value","_socketRef$current3","handleUserSearch","length","encodeURIComponent","text","results","handleDeleteConversation","confirm","isBlocked","blockedUsers","includes","handleBlockUnblock","url","blockId","userRes","updatedUser","handleConfirmAdoption","dogId","isOwner","handleCancelAdoption","reason","className","children","type","onChange","placeholder","style","listStyle","padding","marginBottom","map","onClick","userName","fontSize","color","minHeight","String","displayName","profileImg","display","flexDirection","alignItems","gap","position","left","top","src","alt","width","height","borderRadius","objectFit","border","minWidth","maxWidth","maxHeight","onError","fontWeight","marginTop","join","background","margin","paddingLeft","dog","_dog$adoptionQueue","adopter","a","adoptionQueue","adoptionStatus","textAlign","fontStyle","onKeyDown","key","disabled","trim","dispatchEvent","CustomEvent","right","backgroundColor","justifyContent","boxShadow","cursor","zIndex","title","lineHeight","userSelect","letterSpacing"],"sources":["/Applications/MAMP/htdocs/eky/client/src/components/ChatApp.tsx"],"sourcesContent":["import React, { useState, useEffect, useRef, useCallback } from 'react';\nimport { useTranslation } from 'react-i18next';\nimport '../css/chat-app.css';\nimport '../styles/chatAppNotification.css';\nimport io from 'socket.io-client';\nimport { useAuth } from '../contexts/AuthContext';\n\ninterface UserWithBlocks {\n  _id: string;\n  blockedUsers?: string[];\n}\n\ninterface Message {\n  _id: string;\n  sender: string;\n  recipient: string;\n  message: string;\n  sentAt: string;\n}\n\n\ninterface Conversation {\n  _id: string;\n  participants: string[];\n}\n\ninterface UserWithBlocks {\n  _id: string;\n  blockedUsers?: string[];\n}\n\nconst getApiUrl = () => {\n  if (process.env.REACT_APP_API_URL) return process.env.REACT_APP_API_URL;\n  if (window.location.protocol === 'https:') {\n    // Use same host, but https\n    return `https://${window.location.hostname}`;\n  }\n  if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {\n    return `http://${window.location.hostname}:3001`;\n  }\n  // For mobile/network access, use the network IP (dev only)\n  return `http://172.20.10.2:3001`;\n};\n\nconst ChatApp: React.FC = () => {\n  const { t } = useTranslation();\n  // Helper to refresh online users from server\n  const refreshOnlineUsers = useCallback(() => {\n    if (socketRef.current) {\n      socketRef.current.emit('getOnlineUsers');\n    }\n  }, []);\n  const { user, token, updateUser } = useAuth();\n  const selectedConvoRef = useRef<Conversation | null>(null);\n  const [onlineUsers, setOnlineUsers] = useState<{_id: string, userName: string, profilePicture?: string}[]>([]);\n  const userWithBlocks = user as UserWithBlocks | null;\n  // Profile picture logic\n  const getProfilePictureUrl = () => {\n    if (user && (user as any).profilePicture) {\n      return `${getApiUrl()}${(user as any).profilePicture}`;\n    }\n    return '../img/androcolored-80x80.jpg'; // Default profile picture\n  };\n  const [conversations, setConversations] = useState<Conversation[]>([]);\n  const [convoUsernames, setConvoUsernames] = useState<{[key: string]: string}>({});\n  const [selectedConvo, setSelectedConvo] = useState<Conversation | null>(null);\n  useEffect(() => {\n    selectedConvoRef.current = selectedConvo;\n  }, [selectedConvo]);\n  const [messages, setMessages] = useState<Message[]>([]);\n  const [input, setInput] = useState('');\n  // Remove otherUserId, use only user search and searchResults\n  const [typing, setTyping] = useState(false);\n  const [notification, setNotification] = useState<string | null>(null);\n  const [userSearch, setUserSearch] = useState('');\n  const [searchResults, setSearchResults] = useState<{_id: string, userName: string}[]>([]);\n  const [pendingAdoptions, setPendingAdoptions] = useState<any[]>([]);\n  useEffect(() => {\n    console.log('[ChatApp] onlineUsers state updated:', onlineUsers);\n  }, [onlineUsers]);\n  const socketRef = useRef<ReturnType<typeof io> | null>(null);\n\n  const fetchPendingAdoptions = useCallback(async () => {\n    if (!token) return;\n    console.log('[ChatApp] Fetching pending adoptions...');\n    try {\n      const res = await fetch(`${getApiUrl()}/api/dogs/pending-adoptions`, {\n        headers: { 'Authorization': `Bearer ${token}` }\n      });\n      if (res.ok) {\n        const data = await res.json();\n        console.log('[ChatApp] Current user:', user?._id);\n        console.log('[ChatApp] Pending adoptions:', data);\n        setPendingAdoptions(data);\n      } else {\n        console.error('[ChatApp] Failed to fetch pending adoptions:', res.status);\n      }\n    } catch (err) {\n      console.error('[ChatApp] Error fetching pending adoptions:', err);\n    }\n  }, [token]);\n\n  // Setup socket connection and listeners only once per user/token\n  useEffect(() => {\n    if (user?._id && token) {\n      console.log('[ChatApp] useEffect: user._id and token present.');\n      console.log('[ChatApp] Connecting socket for user:', user._id);\n      fetch(`${getApiUrl()}/api/chat/conversations/${user._id}`, {\n        headers: { 'Authorization': `Bearer ${token}` }\n      })\n        .then(res => {\n          if (!res.ok) {\n            throw new Error(`HTTP ${res.status}: ${res.statusText}`);\n          }\n          return res.json();\n        })\n        .then(async data => {\n          console.log('[ChatApp] Conversations fetched:', data);\n          setConversations(Array.isArray(data) ? data : []);\n          // Fetch usernames for each conversation's other participant\n          const usernames: {[key: string]: string} = {};\n         for (const convo of Array.isArray(data) ? data : []) {\n  const otherId = convo.participants.find((id: string) => id !== user._id);\n  if (otherId) {\n    try {\n      const res = await fetch(`${getApiUrl()}/api/users/${otherId}`, {\n        headers: {\n          'Authorization': `Bearer ${token}`\n        }\n      });\n      if (res.status === 404) {\n        usernames[convo._id] = '[Deleted User]';\n      } else if (res.ok) {\n        const u = await res.json();\n        usernames[convo._id] = u.username || u.name || otherId;\n      } else {\n        usernames[convo._id] = otherId;\n      }\n    } catch (err) {\n      usernames[convo._id] = '[Error]';\n    }\n  }\n}\n          setConvoUsernames(usernames);\n          await fetchPendingAdoptions();\n        })\n      if (!socketRef.current) {\n        socketRef.current = io(getApiUrl());\n        console.log('[ChatApp] Socket.IO connecting to', getApiUrl());\n        socketRef.current.on('connect', () => {\n          console.log('[ChatApp] Socket connected');\n        });\n        socketRef.current.on('connect_error', (error) => {\n          console.error('[ChatApp] Socket connection error:', error);\n        });\n        socketRef.current.on('receiveMessage', (msg) => {\n          console.log('[ChatApp] receiveMessage event:', msg);\n        });\n        socketRef.current.on('refreshConversations', () => {\n          console.log('[ChatApp] refreshConversations event received');\n        });\n        \n        socketRef.current.on('connect', () => {\n          console.log('[ChatApp] Socket connected successfully');\n        });\n        \n        socketRef.current.on('connect_error', (error) => {\n          console.error('[ChatApp] Socket connection error:', error);\n        });\n        \n        socketRef.current.emit('join', user._id);\n        console.log('[ChatApp] Emitted join for user:', user._id);\n        socketRef.current.emit('getOnlineUsers');\n        socketRef.current.on('onlineUsers', (users) => {\n          console.log('[ChatApp] Received onlineUsers:', users);\n          setOnlineUsers(users.filter((u: any) => u._id !== user._id));\n        });\n        socketRef.current.on('userOnline', (userOnline) => {\n          console.log('[ChatApp] userOnline event:', userOnline);\n          setOnlineUsers(prev => {\n            if (prev.some(u => u._id === userOnline._id)) return prev;\n            return [...prev, userOnline].filter(u => u._id !== user._id);\n          });\n        });\n        socketRef.current.on('userOffline', (userOffline) => {\n          console.log('[ChatApp] userOffline event:', userOffline);\n          setOnlineUsers(prev => prev.filter(u => u._id !== userOffline._id));\n        });\n        socketRef.current.on('receiveMessage', (msg) => {\n          console.log('[ChatApp] receiveMessage event:', msg);\n          // Always refresh conversations list\n          fetch(`${getApiUrl()}/api/chat/conversations/${user._id}`, {\n            headers: { 'Authorization': `Bearer ${token}` }\n          })\n            .then(res => res.json())\n            .then(async data => {\n              setConversations(Array.isArray(data) ? data : []);\n              // Fetch usernames for each conversation's other participant\n              const usernames: {[key: string]: string} = {};\n              for (const convo of Array.isArray(data) ? data : []) {\n                const otherId = convo.participants.find((id: string) => id !== user._id);\n                if (otherId) {\n                  const res = await fetch(`${getApiUrl()}/api/users/${otherId}`);\n                  if (res.ok) {\n                    const u = await res.json();\n                    usernames[convo._id] = u.username || u.name || otherId;\n                  } else {\n                    usernames[convo._id] = otherId;\n                  }\n                }\n              }\n              setConvoUsernames(usernames);\n              // Always refresh messages for the relevant conversation\n              if (msg.conversationId) {\n                fetch(`${getApiUrl()}/api/chat/messages/${msg.conversationId}`, {\n                  headers: { 'Authorization': `Bearer ${token}` }\n                })\n                  .then(res => res.json())\n                  .then(messages => {\n                    setMessages(messages);\n                    // Show notification for system messages\n                    if (msg.sender === null && msg.message) {\n                      setNotification(msg.message);\n                      setTimeout(() => setNotification(null), 4000);\n                      // Auto-select the conversation if not already selected\n                      if (!selectedConvo || selectedConvo._id !== msg.conversationId) {\n                        const foundConvo = (Array.isArray(data) ? data : []).find((c: any) => c._id === msg.conversationId);\n                        if (foundConvo) setSelectedConvo(foundConvo);\n                      }\n                      // Mark conversation as having a new system message (badge)\n                      setConvoUsernames(prev => ({ ...prev, [msg.conversationId]: (prev[msg.conversationId] || '') + ' •' }));\n                    }\n                  });\n              }\n              // Always refresh pending adoptions on receiveMessage (for adoption events)\n              fetchPendingAdoptions();\n            });\n        });\n        socketRef.current.on('typing', ({ from }) => {\n          setTyping(true);\n          setTimeout(() => setTyping(false), 1500);\n        });\n        socketRef.current.on('notification', ({ from, message }) => {\n          setNotification(`New message from ${from}: ${message}`);\n          setTimeout(() => setNotification(null), 3000);\n        });\n        socketRef.current.on('refreshConversations', () => {\n          console.log('[ChatApp] refreshConversations event received');\n          fetch(`${getApiUrl()}/api/chat/conversations/${user._id}`, {\n            headers: { 'Authorization': `Bearer ${token}` }\n          })\n            .then(res => {\n              if (!res.ok) {\n                throw new Error(`HTTP ${res.status}: ${res.statusText}`);\n              }\n              return res.json();\n            })\n            .then(data => {\n              console.log('[ChatApp] Conversations refreshed:', data);\n              setConversations(Array.isArray(data) ? data : []);\n            })\n            .catch(err => {\n              console.error('[ChatApp] Error refreshing conversations:', err);\n            });\n          fetchPendingAdoptions();\n        });\n      }\n    }\n    return () => {\n      socketRef.current?.disconnect();\n      socketRef.current = null;\n    };\n  }, [user, token, selectedConvo, fetchPendingAdoptions]);\n\n  useEffect(() => {\n    if (selectedConvo && token) {\n      console.log('[ChatApp] Fetching messages for selectedConvo:', selectedConvo._id);\n      fetch(`${getApiUrl()}/api/chat/messages/${selectedConvo._id}`, {\n        headers: { 'Authorization': `Bearer ${token}` }\n      })\n        .then(res => res.json())\n        .then(setMessages);\n    }\n  }, [selectedConvo, token]);\n  useEffect(() => {\n    if (selectedConvo && token) {\n      console.log('[ChatApp] Fetching messages for selectedConvo (user/token change):', selectedConvo._id);\n      fetch(`${getApiUrl()}/api/chat/messages/${selectedConvo._id}`, {\n        headers: { 'Authorization': `Bearer ${token}` }\n      })\n        .then(res => res.json())\n        .then(setMessages);\n    }\n  }, [user, token, selectedConvo]);\n\n  const startConversation = async (otherUserId: string) => {\n    if (!otherUserId || !token) return;\n    const res = await fetch(`${getApiUrl()}/api/chat/conversation`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${token}`\n      },\n      body: JSON.stringify({ userId: user._id, otherUserId })\n    });\n    const convo = await res.json();\n    setSelectedConvo(convo);\n    setConversations(prev => [...prev, convo]);\n    setUserSearch('');\n    setSearchResults([]);\n  };\n\n  const sendMessage = async () => {\n    if (!input || !selectedConvo || !token) return;\n    const recipient = selectedConvo.participants.find(id => id !== user._id);\n    socketRef.current?.emit('sendMessage', {\n      conversationId: selectedConvo._id,\n      sender: user._id,\n      recipient,\n      message: input\n    });\n    await fetch(`${getApiUrl()}/api/chat/message`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${token}`\n      },\n      body: JSON.stringify({\n        conversationId: selectedConvo._id,\n        sender: user._id,\n        recipient,\n        message: input\n      })\n    });\n    // Do not update messages here; wait for real-time event\n    setInput('');\n  };\n\n  // Typing indicator\n  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    setInput(e.target.value);\n    if (selectedConvo) {\n      const recipient = selectedConvo.participants.find(id => id !== user._id);\n      socketRef.current?.emit('typing', { recipient, sender: user._id });\n    }\n  };\n\n  // User search\n  const handleUserSearch = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    setUserSearch(e.target.value);\n    if (e.target.value.length > 1) {\n      try {\n        const res = await fetch(`${getApiUrl()}/api/users/search?query=${encodeURIComponent(e.target.value)}`, {\n          headers: {\n            'Authorization': `Bearer ${token}`\n          }\n        });\n        if (!res.ok) {\n          console.error('User search failed:', res.status, await res.text());\n          setSearchResults([]);\n          return;\n        }\n        const results = await res.json();\n        setSearchResults(results);\n      } catch (err) {\n        console.error('User search error:', err);\n        setSearchResults([]);\n      }\n    } else {\n      setSearchResults([]);\n    }\n  };\n\n  // Handler for deleting conversation\n  const handleDeleteConversation = async () => {\n    if (!selectedConvo || !token) return;\n    if (!window.confirm('Delete this conversation? This cannot be undone.')) return;\n    await fetch(`${getApiUrl()}/api/chat/messages/${selectedConvo._id}`, {\n      method: 'DELETE',\n      headers: { 'Authorization': `Bearer ${token}` }\n    });\n    setConversations(conversations.filter(c => c._id !== selectedConvo._id));\n    setSelectedConvo(null);\n    setMessages([]);\n  };\n\n  // Handler for block/unblock user\n  const isBlocked = selectedConvo && userWithBlocks && userWithBlocks.blockedUsers && selectedConvo.participants.some(\n    id => id !== userWithBlocks._id && userWithBlocks.blockedUsers!.includes(id)\n  );\n  const otherUserId = selectedConvo && userWithBlocks ? selectedConvo.participants.find(id => id !== userWithBlocks._id) : null;\n  const handleBlockUnblock = async () => {\n    if (!otherUserId || !token) return;\n    const url = isBlocked ? '/api/chat/unblock' : '/api/chat/block';\n    await fetch(`${getApiUrl()}${url}`, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },\n      body: JSON.stringify({ userId: user._id, blockId: otherUserId })\n    });\n    // Fetch updated user and update AuthContext state\n    const userRes = await fetch(`${getApiUrl()}/api/users/${user._id}`, {\n      headers: { 'Authorization': `Bearer ${token}` }\n    });\n    if (userRes.ok) {\n      const updatedUser = await userRes.json();\n      updateUser(updatedUser);\n    }\n    // Emit a socket event to update both users' conversations in real time\n    if (socketRef.current) {\n      socketRef.current.emit('refreshConversations', { userId: user._id, otherUserId });\n    }\n    // Refetch conversations for this user\n    fetch(`${getApiUrl()}/api/chat/conversations/${user._id}`, {\n      headers: { 'Authorization': `Bearer ${token}` }\n    })\n      .then(res => res.json())\n      .then(data => setConversations(Array.isArray(data) ? data : []));\n    // Optionally, refetch selected conversation if still valid\n    if (selectedConvo) {\n      fetch(`${getApiUrl()}/api/chat/messages/${selectedConvo._id}`, {\n        headers: { 'Authorization': `Bearer ${token}` }\n      })\n        .then(res => res.json())\n        .then(setMessages);\n    }\n  };\n\n  // Handler for confirming adoption\n  const handleConfirmAdoption = async (dogId: string, isOwner: boolean) => {\n    if (!token) return;\n    try {\n      const res = await fetch(`${getApiUrl()}/api/dogs/confirm-adoption`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },\n        body: JSON.stringify({ dogId, isOwner })\n      });\n      if (res.ok) {\n        await fetchPendingAdoptions();\n        setNotification(t('chat.adoptionConfirmed'));\n        // Always refresh conversations\n        fetch(`${getApiUrl()}/api/chat/conversations/${user._id}`, {\n          headers: { 'Authorization': `Bearer ${token}` }\n        })\n          .then(res => res.json())\n          .then(data => {\n            setConversations(Array.isArray(data) ? data : []);\n            // If selected convo is gone, clear selection and messages\n            if (selectedConvo && !data.find((c: any) => c._id === selectedConvo._id)) {\n              setSelectedConvo(null);\n              setMessages([]);\n              setNotification(t('chat.adoptionCompletedClosed'));\n            } else if (selectedConvo) {\n              // Refresh messages if convo still exists\n              fetch(`${getApiUrl()}/api/chat/messages/${selectedConvo._id}`, {\n                headers: { 'Authorization': `Bearer ${token}` }\n              })\n                .then(res => res.json())\n                .then(setMessages);\n            }\n          });\n      }\n    } catch (err) {\n      console.error('Confirm adoption error:', err);\n    }\n  };\n\n  // Handler for canceling adoption\n  const handleCancelAdoption = async (dogId: string) => {\n    if (!token) return;\n    try {\n      const res = await fetch(`${getApiUrl()}/api/dogs/${dogId}/adopt-cancel`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },\n        body: JSON.stringify({ reason: '' })\n      });\n      if (res.ok) {\n        await fetchPendingAdoptions();\n        setNotification(t('chat.adoptionCanceled'));\n        fetch(`${getApiUrl()}/api/chat/conversations/${user._id}`, {\n          headers: { 'Authorization': `Bearer ${token}` }\n        })\n          .then(res => res.json())\n          .then(data => {\n            setConversations(Array.isArray(data) ? data : []);\n            if (selectedConvo && !data.find((c: any) => c._id === selectedConvo._id)) {\n              setSelectedConvo(null);\n              setMessages([]);\n              setNotification(t('chat.adoptionCanceledClosed'));\n            } else if (selectedConvo) {\n              fetch(`${getApiUrl()}/api/chat/messages/${selectedConvo._id}`, {\n                headers: { 'Authorization': `Bearer ${token}` }\n              })\n                .then(res => res.json())\n                .then(setMessages);\n            }\n          });\n      }\n    } catch (err) {\n      console.error('Cancel adoption error:', err);\n    }\n  };\n\n  return (\n    <div className=\"chat-app-container\">\n      <div className=\"chat-app-sidebar\">\n        <input\n          className=\"chat-app-search\"\n          type=\"text\"\n          value={userSearch}\n          onChange={handleUserSearch}\n          placeholder={t('chat.searchUsersPlaceholder')}\n        />\n        {searchResults.length > 0 && (\n          <ul style={{ listStyle: 'none', padding: 0, marginBottom: 4 }}>\n            {searchResults.map(u => (\n              <li key={u._id}>\n                <button className=\"chat-app-convo-btn\" onClick={() => startConversation(u._id)}>{u.userName}</button>\n              </li>\n            ))}\n          </ul>\n        )}\n\n        {/* Active/Online Users List */}\n        <div className=\"chat-app-online-users\">\n          <b style={{ fontSize: 13, color: '#43b581' }}>Online Users</b>\n          <ul style={{ listStyle: 'none', padding: 0, minHeight: 40 }}>\n            {onlineUsers.filter(u => {\n              const id = typeof u === 'string' ? u : u._id;\n              return String(id) !== String(user._id);\n            }).length === 0 && (\n              <li style={{ color: '#aaa', fontSize: 12 }}>{t('chat.noUsersOnline')}</li>\n            )}\n            {onlineUsers.filter(u => {\n              const id = typeof u === 'string' ? u : u._id;\n              return String(id) !== String(user._id);\n            }).map(u => {\n              let displayName = '';\n              let profileImg = '../img/androcolored-80x80.jpg';\n              if (typeof u === 'string') {\n                displayName = u;\n              } else if (u && typeof u === 'object') {\n                displayName = u.userName || u._id || 'Unknown';\n                if (u.profilePicture) {\n                  profileImg = `${getApiUrl()}${u.profilePicture}`;\n                }\n              }\n              return (\n                <li key={typeof u === 'string' ? u : u._id} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 4, marginBottom: 8 }}>\n                  <span className=\"chat-app-online-dot\" style={{ position: 'absolute', left: 8, top: 8 }} />\n                  <img\n                    src={profileImg}\n                    alt={displayName}\n                    style={{ width: 40, height: 40, borderRadius: '50%', objectFit: 'cover', border: '2px solid #ddd', minWidth: '40px', minHeight: '40px', maxWidth: '60px', maxHeight: '60px', marginBottom: 4 }}\n                    onError={e => { (e.target as HTMLImageElement).src = '../img/androcolored-80x80.jpg'; }}\n                  />\n                  <button className=\"chat-app-convo-btn\" style={{ fontSize: 13, fontWeight: 500, marginTop: 2 }} onClick={() => startConversation(typeof u === 'string' ? u : u._id)}>{displayName}</button>\n                </li>\n              );\n            })}\n          </ul>\n        </div>\n\n        <div className=\"chat-app-convos\">\n          <b style={{ fontSize: 13, color: '#2196f3' }}>Conversations</b>\n          <ul style={{ listStyle: 'none', padding: 0 }}>\n            {conversations.map(convo => (\n              <li key={convo._id}>\n                <button\n                  className={`chat-app-convo-btn${selectedConvo?._id === convo._id ? ' selected' : ''}`}\n                  onClick={() => setSelectedConvo(convo)}\n                >\n                  {convoUsernames[convo._id] || convo.participants.filter(id => id !== user._id).join(', ')}\n                </button>\n              </li>\n            ))}\n          </ul>\n        </div>\n      </div>\n      <div className=\"chat-app-main\">\n        {/* DEBUG: Show pending adoptions */}\n        <div style={{ background: '#fff3cd', padding: '8px', marginBottom: '8px', border: '1px solid #ffeaa7', borderRadius: '4px' }}>\n          <strong>{t('chat.pendingAdoptions')}</strong>\n          {pendingAdoptions.length > 0 ? (\n            <ul style={{ margin: 0, paddingLeft: '20px' }}>\n              {pendingAdoptions.map(dog => {\n                let adopter = 'None';\n                const a = dog.adoptionQueue?.adopter;\n                if (a) {\n                  if (typeof a === 'string') {\n                    adopter = a;\n                  } else if (typeof a === 'object') {\n                    adopter = a.name || a.username || a._id || 'Unknown';\n                  }\n                }\n                return (\n                  <li key={dog._id}>\n                    {dog.name} - Owner: {dog.user.name} ({dog.user._id === user._id ? 'You' : 'Other'}) - Adopter: {adopter}\n                  </li>\n                );\n              })}\n            </ul>\n          ) : (\n            <div style={{ color: '#c00', fontSize: '13px', marginTop: 6 }}>\n              {t('chat.noPendingAdoptions')}\n            </div>\n          )}\n        </div>\n\n        {/* Conversation actions always at top for all devices */}\n        {selectedConvo && (\n          <div className=\"chat-app-actions-row\">\n            <button className=\"chat-app-action-btn delete\" onClick={handleDeleteConversation}>Delete</button>\n            <button className={`chat-app-action-btn ${isBlocked ? 'unblock' : 'block'}`} onClick={handleBlockUnblock}>{isBlocked ? 'Unblock' : 'Block'}</button>\n            {pendingAdoptions.filter(dog => dog.adoptionStatus !== 'adopted').length > 0 ? (\n              pendingAdoptions.filter(dog => dog.adoptionStatus !== 'adopted').map(dog => (\n                <span key={dog._id} style={{ display: 'inline-flex', gap: 8 }}>\n                  <button\n                    className=\"chat-app-action-btn confirm\"\n                    onClick={() => handleConfirmAdoption(dog._id, String(dog.user._id || dog.user) === String(user._id))}\n                  >\n                    Confirm\n                  </button>\n                  <button\n                    className=\"chat-app-action-btn cancel\"\n                    onClick={() => handleCancelAdoption(dog._id)}\n                    style={{ background: '#e74c3c', color: 'white' }}\n                  >\n                    Cancel\n                  </button>\n                </span>\n              ))\n            ) : (\n              <span style={{ color: '#c00', fontSize: '12px' }}>No pending adoptions found.</span>\n            )}\n          </div>\n        )}\n          <div className=\"chat-app-messages\">\n          {messages.map(msg => (\n            <div\n              key={msg._id}\n              className={`chat-app-message${user && msg.sender === user._id ? ' self' : ''}${msg.sender === null ? ' system' : ''}`}\n              style={msg.sender === null ? { textAlign: 'center', color: '#888', fontStyle: 'italic', background: '#f9f9f9', border: 'none', margin: '8px 0' } : {}}\n            >\n              <span className={`chat-app-bubble${user && msg.sender === user._id ? ' self' : ''}`}>{msg.message}</span>\n            </div>\n          ))}\n          {typing && <div className=\"chat-app-typing\">{t('chat.typing')}</div>}\n        </div>\n        {selectedConvo && (\n          <div className=\"chat-app-input-row\">\n            <input\n              className=\"chat-app-input\"\n              type=\"text\"\n              value={input}\n              onChange={handleInputChange}\n              onKeyDown={e => { if (e.key === 'Enter') sendMessage(); }}\n              placeholder={'Type a message...'}\n            />\n            <button\n              className=\"chat-app-send-btn\"\n              onClick={sendMessage}\n              disabled={!input.trim()}\n            >Send</button>\n          </div>\n        )}\n        {notification && (\n          <div className=\"chat-app-notification\">{notification}</div>\n        )}\n      </div>\n      {/* Close button at top right (desktop), static on mobile) */}\n      <button\n        onClick={() => window.dispatchEvent(new CustomEvent('closeChatModal'))}\n        style={{\n          position: 'absolute',\n          top: 10,\n          right: 10,\n          width: 56,\n          height: 56,\n          backgroundColor: '#e74c3c',\n          color: '#fff',\n          border: 'none',\n          borderRadius: '50%',\n          display: 'flex',\n          alignItems: 'center',\n          justifyContent: 'center',\n          boxShadow: '0 4px 12px rgba(0,0,0,0.3)',\n          cursor: 'pointer',\n          zIndex: 2147483647,\n          padding: 0\n        }}\n        title=\"Close\"\n        aria-label=\"Close\"\n      >\n        <span style={{\n          fontSize: 40,\n          fontWeight: 900,\n          lineHeight: '56px',\n          width: '100%',\n          textAlign: 'center',\n          display: 'block',\n          userSelect: 'none',\n          letterSpacing: 2\n        }}>×</span>\n      </button>\n    </div>\n  );\n};\n\nexport default ChatApp;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}